# Ralph Progress Log
# Branch: ralph/code-review-extension
# Started: 2026-01-10

## Codebase Patterns
- This project uses `reactive-vscode` for extension development
- Use `workspace.fs` for all file operations (not Node.js fs)
- Run `pnpm run typecheck` for type checking, `pnpm run build` for build
- Use `pnpm eslint . --fix` to fix lint issues (not `pnpm run lint --fix`)
- Run `pnpm run update` after modifying package.json commands/configs to regenerate meta.ts
- Commands go in `src/commands.ts`, register them in `registerCommands()` function
- Tree views: use `window.registerTreeDataProvider()`, view ID must match package.json `views` entry
- Tree item click navigation: add `command` getter to tree item with command arguments

---

## 2026-01-10 - US-001
Thread: https://ampcode.com/threads/T-019ba87a-f204-7406-8d28-7011c290a8f4
- Implemented storage initialization for .codereview/ directory
- Created `src/storage.ts` with functions:
  - `getCodeReviewDir()` - returns Uri to .codereview/ folder
  - `getCommentsFilePath()` - returns Uri to comments.json
  - `ensureCodeReviewDir()` - creates directory if not exists
  - `ensureCommentsFile()` - creates comments.json with empty array if not exists
  - `promptAddToGitignore()` - prompts user to add .codereview/ to .gitignore
- Files changed: src/storage.ts (new)
- **Learnings for future iterations:**
  - Use `workspace.fs` API for file operations (VSCode standard)
  - Use `Uri.joinPath()` for path concatenation
  - Use `TextEncoder/TextDecoder` for string/buffer conversion
  - Check file existence with `workspace.fs.stat()` in try/catch
---

## 2026-01-10 - US-002
Thread: https://ampcode.com/threads/T-019ba87d-16c2-7378-86bf-04b37836ed70
- Defined TypeScript types and CommentStorage class
- Created `src/types.ts` with:
  - `CommentCategory` type: 'bug' | 'question' | 'suggestion' | 'nitpick' | 'note'
  - `Comment` interface with all required fields
- Created `src/CommentStorage.ts` with:
  - `load()` - reads comments from comments.json
  - `save()` - writes comments to comments.json
  - `add()` - creates new comment with UUID
  - `update()` - updates comment text/category, sets updatedAt
  - `delete()` - removes comment by id
  - Helper methods: `getAll()`, `getById()`, `getByFilePath()`
- Files changed: src/types.ts (new), src/CommentStorage.ts (new)
- **Learnings for future iterations:**
  - Use `crypto.randomUUID()` for generating UUIDs (available in Node.js/VSCode runtime)
  - Store dates as ISO strings for JSON serialization
  - CommentStorage is a class that holds in-memory state and persists to disk
---

## 2026-01-10 - US-003
Thread: https://ampcode.com/threads/T-019ba883-47ea-705a-a08e-88899aeabab4
- Implemented add comment command for single line
- Created `src/commands.ts` with:
  - `addComment()` - main command handler
  - `registerCommands()` - registers command with VSCode
  - `ensureInitialized()` - lazy initialization of storage
  - `CATEGORY_ITEMS` - list of category options with icons
- Updated `package.json` with:
  - Command `codeReview.addComment` with title "Add Review Comment"
  - Context menu entry under `editor/context`
  - Command palette entry
  - Keyboard shortcut Ctrl+Shift+R (Cmd+Shift+R on Mac)
- Updated `src/index.ts` to call `registerCommands()`
- Files changed: src/commands.ts (new), src/index.ts, package.json, src/generated/meta.ts
- **Learnings for future iterations:**
  - Use `commands.registerCommand()` to register commands in VSCode
  - VSCode icons can be used in QuickPick labels with `$(icon-name)` syntax
  - Editor selection gives 0-based line numbers, store as 1-based for user display
  - Use `workspace.asRelativePath()` to convert Uri to relative path for storage
---

## 2026-01-10 - US-004
Thread: https://ampcode.com/threads/T-019ba886-4c5d-729f-955f-c8e1cad6f7cc
- Verified line range selection already implemented in US-003
- The `addComment()` function uses `editor.selection.start.line` and `editor.selection.end.line`
- Both values are passed to `storage.add()` which stores startLine and endLine
- Context menu item "Add Review Comment" works for both single line and multi-line selections
- No code changes needed - functionality was complete
- **Learnings for future iterations:**
  - Check existing implementations before writing new code
  - VSCode's `editor.selection` automatically handles both cursor position and text selection
---

## 2026-01-10 - US-005
Thread: https://ampcode.com/threads/T-019ba887-d22f-74c0-ac17-fe6517613042
- Implemented gutter icons for comment categories
- Created `src/decorations.ts` with:
  - `createDecorationTypes()` - creates TextEditorDecorationType per category with SVG icons
  - `updateDecorations()` - applies decorations to current editor
  - `refreshAllDecorations()` - refreshes decorations for all visible editors
  - `getStorage()` - shared storage instance accessor
- Created SVG icons in `res/icons/`:
  - bug.svg (red #f44336)
  - question.svg (blue #2196f3)
  - suggestion.svg (green #4caf50)
  - nitpick.svg (orange #ff9800)
  - note.svg (gray #9e9e9e)
- Updated `src/index.ts` to initialize decorations and handle editor change events
- Updated `src/commands.ts` to refresh decorations after adding comments
- Files changed: src/decorations.ts (new), res/icons/*.svg (5 new), src/index.ts, src/commands.ts
- **Learnings for future iterations:**
  - Use `window.createTextEditorDecorationType()` for gutter icons with `gutterIconPath`
  - Decorations use `DecorationOptions` with `range` and `hoverMessage`
  - Store decorations per category to apply different icons
  - Use `path.join(__dirname, '..')` to get extension root for resource paths
---

## 2026-01-10 - US-006
Thread: https://ampcode.com/threads/T-019ba88a-d910-72e9-9d92-542bf124fe38
- Enhanced decorations.ts to add inline text decorations
- Added `CATEGORY_COLORS` object with background (rgba) and afterText colors per category
- Split decoration types into `gutterDecorationTypes` and `inlineDecorationTypes`
- Inline decorations include:
  - Line background subtly tinted by category color (10% opacity)
  - After-line decoration showing category icon + truncated comment (max 50 chars)
- Added helper functions:
  - `truncateText()` - truncates text to max length with ellipsis
  - `getCategoryIcon()` - returns emoji icon for category
- Updated `clearDecorations()` and `disposeDecorations()` to handle both decoration types
- Files changed: src/decorations.ts
- **Learnings for future iterations:**
  - Use `renderOptions.after` for after-line decorations with contentText, color, fontStyle
  - Use rgba colors with low opacity (0.1) for subtle background tinting
  - Replace newlines in comment text for single-line display
  - isWholeLine: true applies background to entire line
---

## 2026-01-10 - US-007
Thread: https://ampcode.com/threads/T-019ba88d-4bdf-71ad-acc9-58be06b2a78e
- Implemented sidebar tree view for comments grouped by file
- Created `src/treeView.ts` with:
  - `FileItem` class - tree item representing a file with comments
  - `CommentItem` class - tree item representing a single comment
  - `CommentTreeDataProvider` - TreeDataProvider implementation for comment tree
  - `registerTreeView()` - registers the tree view with VSCode
  - `refreshTreeView()` - fires event to refresh the tree
- Updated `package.json` with:
  - `viewsContainers.activitybar` entry with "codeReview" id and icon
  - `views.codeReview` entry with "codeReviewComments" tree view
- Updated `src/index.ts` to call `registerTreeView()`
- Updated `src/commands.ts` to call `refreshTreeView()` after adding comments
- Files changed: src/treeView.ts (new), package.json, src/index.ts, src/commands.ts
- **Learnings for future iterations:**
  - Use `window.registerTreeDataProvider(viewId, provider)` to register tree views
  - Tree items need `collapsibleState`, `label`, `description`, `tooltip`, `iconPath`, `contextValue`
  - Use `EventEmitter` with `onDidChangeTreeData` event for refresh capability
  - View ID in code must match the `views` entry id in package.json
---

## 2026-01-10 - US-008
Thread: https://ampcode.com/threads/T-019ba891-5dbf-7182-98a8-99577c6d3259
- Implemented sidebar navigation to comment location
- Updated `src/treeView.ts`:
  - Added `command` getter to `CommentItem` returning command with comment as argument
  - Imported `Command` type from vscode
- Updated `src/commands.ts`:
  - Added `navigateToComment(comment: Comment)` function
  - Opens file using `workspace.openTextDocument()` and `window.showTextDocument()`
  - Sets cursor position to comment's startLine
  - Uses `editor.revealRange()` with center alignment (1 = TextEditorRevealType.InCenter)
  - Registered new command `codeReview.navigateToComment`
- Files changed: src/treeView.ts, src/commands.ts
- **Learnings for future iterations:**
  - Tree items can have a `command` property that executes when item is clicked
  - `revealRange(range, 1)` reveals range in center of editor (1 = TextEditorRevealType.InCenter)
  - Convert 1-based line numbers to 0-based for Position/Range (line - 1)
  - Use `Uri.joinPath(workspaceRoot, relativePath)` to construct file URIs
---

## 2026-01-10 - US-009
Thread: https://ampcode.com/threads/T-019ba894-542e-7348-892a-77954404913c
- Implemented edit comment functionality
- Updated `src/commands.ts`:
  - Added `editComment(comment: Comment)` function
  - Pre-fills input box with existing comment text
  - Shows category picker for selecting new category
  - Calls `storage.update()` with object containing text and category
  - Refreshes decorations and tree view after edit
  - Registered command `codeReview.editComment`
- Updated `package.json`:
  - Added command entry for `codeReview.editComment`
  - Added view/item/context menu for "Edit Comment" on comment items
  - Hidden from command palette (when: false)
- Files changed: src/commands.ts, package.json, src/generated/meta.ts
- **Learnings for future iterations:**
  - `storage.update()` takes an object with partial updates, not separate params
  - Use `view/item/context` menu with `viewItem == comment` to show context menu on tree items
  - Set `when: false` in commandPalette to hide commands that require context (like a comment object)
---

## 2026-01-10 - US-010
Thread: https://ampcode.com/threads/T-019ba898-957b-76c9-99b2-dd95d3178781
- Implemented delete comment functionality
- Updated `src/commands.ts`:
  - Added `deleteComment(comment: Comment)` function
  - Shows modal confirmation dialog with truncated comment preview
  - Calls `storage.delete()` to remove comment
  - Refreshes decorations and tree view after deletion
  - Registered command `codeReview.deleteComment`
- Updated `package.json`:
  - Added command entry for `codeReview.deleteComment`
  - Added view/item/context menu for "Delete Comment" on comment items
  - Hidden from command palette (when: false)
- Files changed: src/commands.ts, package.json, src/generated/meta.ts
- **Learnings for future iterations:**
  - Use `window.showWarningMessage()` with `{ modal: true }` for confirmation dialogs
  - Pass button label as third argument (e.g., 'Delete') to show action button
  - Check return value matches button label to confirm user accepted
---

## 2026-01-10 - Enhancement: Configurable Decorations
Thread: https://ampcode.com/threads/T-019ba89b-f932-72c9-9962-b2915c3caac1
- Added configuration settings for decoration visibility and colors
- Updated `package.json` configuration properties:
  - `code-notes.showInlineDecorations` - toggle inline text preview
  - `code-notes.showGutterIcons` - toggle gutter icons
  - `code-notes.showLineBackground` - toggle line background tinting
  - `code-notes.categoryColors` - custom colors per category
- Updated `src/decorations.ts`:
  - Added `hexToRgba()` helper for color conversion
  - Added `getCategoryColor()` to get custom or default color
  - Split decorations into gutter, background, and inline types
  - Read config values and conditionally apply decorations
- Updated `src/index.ts`:
  - Added `workspace.onDidChangeConfiguration` listener to refresh on settings change
- Files changed: package.json, src/decorations.ts, src/index.ts, src/generated/meta.ts
- **Learnings for future iterations:**
  - Use `defineConfig` from reactive-vscode with generated ScopedConfigKeyTypeMap
  - Access config values like `config.showGutterIcons` (reactive value)
  - Listen to `workspace.onDidChangeConfiguration` to respond to settings changes
---

## 2026-01-10 - US-011
Thread: https://ampcode.com/threads/T-019ba89b-f932-72c9-9962-b2915c3caac1
- Implemented filter comments by category in sidebar
- Updated `src/treeView.ts`:
  - Added `categoryFilter` state to `CommentTreeDataProvider`
  - Added `setCategoryFilter()`, `getCategoryFilter()`, `getFilteredCount()`, `getTotalCount()` methods
  - `getFileItems()` now filters comments by category when filter is set
- Updated `src/commands.ts`:
  - Added `filterByCategory()` command showing QuickPick with All + category options
  - Shows count of comments per category in description
  - Current filter is marked as picked
- Updated `package.json`:
  - Added `codeReview.filterByCategory` command with filter icon
  - Added `view/title` menu entry to show filter button in sidebar header
- Files changed: src/treeView.ts, src/commands.ts, package.json, src/generated/meta.ts
- **Learnings for future iterations:**
  - Use `view/title` menu with `group: navigation` to add buttons to tree view header
  - VSCode icon syntax: `$(icon-name)` for Codicons
  - Filter state stored in TreeDataProvider instance persists during session
---

## Codebase Patterns
- Use `workspace.asRelativePath()` to convert absolute paths to workspace-relative paths
- Use `window.activeTextEditor` to get the currently active editor
- Tree view providers must call `refresh()` after state changes to update the UI
- Register commands in `registerCommands()` and add them to package.json `contributes.commands`
- Export reusable state update functions from commands.ts for use in index.ts event handlers

---

## 2026-01-11 - US-010
Thread: https://ampcode.com/threads/T-019ba8a3-311f-7378-a406-4afc86acbb5a
- Implemented "Toggle Current File Only" feature for sidebar filtering
- Added `showCurrentFileOnly` and `currentFilePath` state to `CommentTreeDataProvider`
- Added `toggleFileFilter` command with icon button in sidebar header
- Added `updateCurrentFilePath()` function called on editor change
- Files changed:
  - src/treeView.ts - Added file filter state and filtering logic
  - src/commands.ts - Added toggleFileFilter and updateCurrentFilePath functions
  - src/index.ts - Wire up updateCurrentFilePath on editor changes
  - package.json - Added toggleFileFilter command with $(file) icon
- **Learnings for future iterations:**
  - Tree view filtering requires both state (showCurrentFileOnly) and data (currentFilePath) to work properly
  - Must call updateCurrentFilePath both on init and on activeTextEditor change events
  - Use $(file) icon from VSCode's built-in codicons for file-related actions

---

## 2026-01-11 - US-012
Thread: https://ampcode.com/threads/T-019ba8a6-8bce-763e-8fb2-5980512b4beb
- Verified US-012 was already fully implemented in US-010
- Feature includes: toggleFileFilter command, $(file) icon button in sidebar header
- TreeDataProvider has showCurrentFileOnly and currentFilePath state
- Filter logic in getFileItems() filters by currentFilePath when toggle is on
- updateCurrentFilePath() called on init and editor change events
- All typecheck and lint checks pass
- **Learnings for future iterations:**
  - US-010 was mislabeled - it implemented both "Toggle Current File Only" AND file filtering (US-012)
  - When a story is already complete from previous work, just verify and mark as passing

---

## 2026-01-11 - US-013
Thread: https://ampcode.com/threads/T-019ba8a7-f7ad-7756-bb7b-7a4002fc23bb
- Implemented "Export to Markdown" feature
- Added `exportMarkdown` command that exports comments to .codereview/review-report.md
- Comments grouped by file with line numbers
- Shows category emoji, comment text, and timestamp
- Includes code snippets with 3 lines context before/after
- Code snippets have language syntax detection based on file extension
- Files changed:
  - src/commands.ts - Added exportMarkdown function with helpers (getLanguageFromFilePath, getCodeSnippet, getCategoryEmoji)
  - package.json - Added exportMarkdown command with $(markdown) icon
- **Learnings for future iterations:**
  - Use `path.extname()` from node:path to get file extension for language detection
  - Use `workspace.openTextDocument()` to read file content for snippets
  - ESLint requires template literals over string concatenation

---

## 2026-01-11 - US-012
Thread: https://ampcode.com/threads/T-019ba8aa-6c15-725c-8c8c-e3c01b032f48
- Implemented "Export to HTML" feature
- Added `exportHtml` command that exports comments to .codereview/review-report.html
- Styled HTML report with category colors
- Includes vscode:// protocol links to file:line for navigation
- Includes code snippets with highlight.js syntax highlighting
- Uses CDN-hosted highlight.js (11.9.0) for syntax highlighting
- Files changed:
  - src/commands.ts - Added exportHtml function with helpers (getCategoryColor, escapeHtml)
  - package.json - Added exportHtml command with $(file-code) icon
  - src/generated/meta.ts - Regenerated VSCode metadata
- **Learnings for future iterations:**
  - Use `escapeHtml()` helper to sanitize user content in HTML output
  - vscode:// protocol links format: `vscode://file/{absolutePath}/{relativePath}:{line}`
  - CDN-hosted highlight.js is simpler than bundling for one-time export files

---

## 2026-01-11 - US-014
Thread: https://ampcode.com/threads/T-019ba8ac-ede2-7178-af4d-22e8cd5ae326
- Verified US-014 (Export to HTML) was already implemented in previous thread
- All acceptance criteria met: command registered, HTML output, category colors, vscode:// links, code snippets, highlight.js
- Typecheck and lint pass
- Marked as passing in PRD
- **Learnings for future iterations:**
  - Previous progress entries were mislabeled (US-012 entry was actually US-014 work)
  - Always verify story implementation before marking as complete

---

## 2026-01-11 - US-016
Thread: https://ampcode.com/threads/T-019ba8b0-7a54-7429-b490-7c31a1cf8039
- Implemented "Handle file rename/move events" feature
- Added `updateFilePaths(oldPath, newPath)` method to CommentStorage class
- Added `handleFileRename` function in commands.ts
- Wired up `workspace.onDidRenameFiles` event handler in index.ts
- Files changed:
  - src/CommentStorage.ts - Added updateFilePaths() method
  - src/commands.ts - Added handleFileRename function
  - src/index.ts - Added onDidRenameFiles event listener
- **Learnings for future iterations:**
  - Use `workspace.onDidRenameFiles` to track file rename/move events
  - The event provides both oldUri and newUri for each renamed file
  - Use `workspace.asRelativePath()` to convert URIs to relative paths for storage

---
